<!DOCTYPE html>
<html>
<head>
    <title>Feature Schedule Report</title>
    <!--  (c) 2015 Rally Software Development Corp.  All Rights Reserved. -->
    <!--  Build Date: Mon Aug 24 2015 09:42:35 GMT-0700 (PDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Mon Aug 24 2015 09:42:35 GMT-0700 (PDT)";
        var CHECKSUM = 41292372616;
    </script>
    
    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
             
/**
 * A link that pops up a version dialog box
 */

Ext.define('Rally.technicalservices.InfoLink',{
    extend: 'Ext.Component',
    alias: 'widget.tsinfolink',
    
    /**
     * @cfg {String} informationHtml
     * Additional text to be displayed on the popup dialog (for exmaple,
     * to add a description of the app's use or functionality)
     */
    informationHtml: null,
    
    /**
     * 
     * cfg {String} title
     * The title for the dialog box
     */
     title: "Build Information",
    
    renderTpl: "<div id='{id}-infolinkWrap' class='tsinfolink'>i</div>",

    initComponent: function() {
        this.callParent(arguments);
       
    },
    
    onRender: function() {
        this.callParent(arguments);
        this.mon(this.el,'click',this.onClick,this);
    },
    _generateChecksum: function(string){
        var chk = 0x12345678,
            i;
        string = string.replace(/var CHECKSUM = .*;/,"");
        string = string.replace(/\s/g,"");  //Remove all whitespace from the string.
        
        for (i = 0; i < string.length; i++) {
            chk += (string.charCodeAt(i) * i);
        }
    
        return chk;
    },
    _checkChecksum: function(container) {
        var me = this;
        Ext.Ajax.request({
            url: document.URL,
            params: {
                id: 1
            },
            success: function (response) {
                text = response.responseText;
                if ( CHECKSUM ) {
                    if ( CHECKSUM !== me._generateChecksum(text) ) {
                        console.log("Checksums don't match!");
                        if ( me.dialog ) {
                            me.dialog.add({xtype:'container',html:'Checksums do not match'});
                        }
                    }
                }
            }
        });
    },
    onClick: function(e) {
        var me = this;
        this._checkChecksum(this);
        
        var dialog_items = [];
        
        if ( this.informationHtml ) {
            dialog_items.push({
                xtype:'container',
                html: this.informationHtml
            });
        }
                
        dialog_items.push({
            xtype:'container',
            html:"This app was created by the Rally Technical Services Team."
        });
        
        if ( APP_BUILD_DATE ) {
            dialog_items.push({
                xtype:'container',
                html:'Build date/time: ' + APP_BUILD_DATE
            });
        }
        
        if (this.dialog){this.dialog.destroy();}
        this.dialog = Ext.create('Rally.ui.dialog.Dialog',{
            defaults: { padding: 5, margin: 5 },
            closable: true,
            draggable: true,
            title: me.title,
            items: dialog_items
        });
        this.dialog.show();
    }
});

/*
 */
Ext.define('Rally.technicalservices.Logger',{
    constructor: function(config){
        Ext.apply(this,config);
    },
    log: function(args){
        var timestamp = "[ " + Ext.util.Format.date(new Date(), "Y-m-d H:i:s.u") + " ]";
        //var output_args = arguments;
        //output_args.unshift( [ "[ " + timestamp + " ]" ] );
        //output_args = Ext.Array.push(output_args,arguments);
        
        var output_args = [];
        output_args = Ext.Array.push(output_args,[timestamp]);
        output_args = Ext.Array.push(output_args, Ext.Array.slice(arguments,0));

        window.console && console.log.apply(console,output_args);
    }

});

Ext.define('Rally.technicalservices.FieldValueDialog', {
    extend: 'Rally.ui.dialog.Dialog',
    alias: 'widget.tsfieldvaluedialog',
    height: 300,
    width: 300,
    layout: 'fit',
    closable: true,
    draggable: true,
    
    config: {
        /**
         * @cfg {String}
         * Title to give to the dialog
         */
        title: 'Choose a Value',
        /**
         * @cfg {Array} (required)
         * Artifact with field
         */
        artifactType: 'PortfolioItem',
        /**
         * @cfg {Array} (required)
         * Field on Artifact to pick
         */
        artifactField: 'State',
        
        /**
         * @cfg {Boolean}
         * Allow multiple selection or not
         */
        multiple: true,

        /**
         * @cfg {Ext.grid.Column}
         * List of columns that will be used in the chooser
         */
        columns: [
            'Name'
        ],

        /**
         * @cfg {String}
         * Text to be displayed on the button when selection is complete
         */
        selectionButtonText: 'Done',

        /**
         * @cfg {Object}
         * The grid configuration to be used when creative the grid of items in the dialog
         */
        gridConfig: {},

        /**
         * @cfg {Array}
         * The values to remove from the selection grid
         */
        removeValues: undefined,
        
        /**
         * 
         * @cfg {Boolean}
         * If true, won't disable the Done button just because nothing is selected
         */
        allowEmptyResponse: false
    },

    selectionCache: [],

    constructor: function(config) {
        this.mergeConfig(config);
        this.callParent([this.config]);
    },

    initComponent: function() {
        this.callParent(arguments);

        this.addEvents(
            /**
             * @event valuechosen
             * Fires when user clicks done after choosing a value
             * @param {Rally.technicalservices.FieldValueDialog} source the dialog
             * @param {String} selection selected value or an array of selected values if multiple is true
             */
            'valuechosen'
        );

        this.addCls(['chooserDialog', 'chooser-dialog']);
    },

    beforeRender: function() {
        this.callParent(arguments);

        this.addDocked({
            xtype: 'toolbar',
            dock: 'bottom',
            padding: '0 0 10 0',
            layout: {
                type: 'hbox',
                pack: 'center'
            },
            ui: 'footer',
            items: [
                {
                    xtype: 'rallybutton',
                    itemId: 'doneButton',
                    text: this.selectionButtonText,
                    cls: 'primary rly-small',
                    scope: this,
                    disabled: !this.allowEmptyResponse,
                    userAction: 'clicked done in dialog',
                    handler: function() {
                        this.fireEvent('valuechosen', this, this.getSelectedRecords());
                        this.close();
                    }
                },
                {
                    xtype: 'rallybutton',
                    text: 'Cancel',
                    cls: 'secondary rly-small',
                    handler: this.close,
                    scope: this,
                    ui: 'link'
                }
            ]
        });

        if (this.introText) {
            this.addDocked({
                xtype: 'component',
                componentCls: 'intro-panel',
                html: this.introText
            });
        }
        this.addGrid();
        
    },
    
    addGrid: function() {
        var me = this;
        
        Rally.data.ModelFactory.getModel({
            type: me.artifactType,
            success: function(model) {
                var store = model.getField(me.artifactField).getAllowedValueStore();
                store.addFilter({ property:'StringValue',operator:'!=',value:'' });
                
                me.buildGrid(store);
            }
        });
    },

    buildGrid: function(store) {
        if (this.grid) {
            this.grid.destroy();
        }

        var me = this;
        var selectionConfig = {
            mode: this.multiple ? 'SIMPLE' : 'SINGLE',
            allowDeselect: true
        };
        this.grid = Ext.create('Rally.ui.grid.Grid', Ext.Object.merge({
            autoAddAllModelFieldsAsColumns: false,
            columnCfgs: [{dataIndex:'StringValue', text: 'Values'}],
            enableEditing: false,
            enableColumnHide: false,
            enableColumnMove: false,
            selModel: Ext.create('Rally.ui.selection.CheckboxModel', Ext.apply(selectionConfig, {
                enableKeyNav: false,
                isRowSelectable: function (record) {
                    return true;
                }
            })),
            showRowActionsColumn: false,
            store: store,
            viewConfig: {
                emptyText: Rally.ui.EmptyTextFactory.get('defaultText'),
                publishLoadMessages: false
            }
        }, this.config.gridConfig));
        
        this.mon(this.grid, {
            beforeselect: this._onGridSelect,
            beforedeselect: this._onGridDeselect,
            load: this._onGridLoad,
            scope: this
        });
        
        this.add(this.grid);
    },
    
    _onGridLoad: function() {
        this.selectionCache = [];
    },
    /**
     * Get the records currently selected in the dialog
     * {Rally.data.Model}|{Rally.data.Model[]}
     */
    getSelectedRecords: function() {
        return this.multiple ? this.selectionCache : this.selectionCache[0];
    },
    
    _enableDoneButton: function() {
        if ( this.allowEmptyResponse ) {
            return;
        }
        this.down('#doneButton').setDisabled(this.selectionCache.length ? false : true);
    },

    _findRecordInSelectionCache: function(record){
        return _.findIndex(this.selectionCache, function(cachedRecord) {
            return cachedRecord.get('StringValue') === record.get('StringValue');
        });
    },

    _onGridSelect: function(selectionModel, record) {
        var index = this._findRecordInSelectionCache(record);
        if (index === -1) {
            if (!this.multiple) {
                this.selectionCache = [];
            }
            this.selectionCache.push(record);
        }

        this._enableDoneButton();
    },

    _onGridDeselect: function(selectionModel, record) {
        var index = this._findRecordInSelectionCache(record);
        if (index !== -1) {
            this.selectionCache.splice(index, 1);
        }

        this._enableDoneButton();
    }
        
});

Ext.define('Rally.technicalservices.dialog.Filter',{
    extend: Rally.ui.dialog.Dialog,
    logger: new Rally.technicalservices.Logger(),
    model: 'PortfolioItem/Feature',
    whitelistFields: ['State'],
    includeDropdownFields: true,
    autoShow: true,
    componentCls: "rly-popover dark-container",
    app: null,
    initComponent: function() {
        this.items = this._getItems();
        this.buttons = this._getButtonConfig();
        this.callParent(arguments);
        this.addEvents(
            'customFilter'
        );

        Rally.data.ModelFactory.getModel({
            type: this.model,
            scope: this,
            success: function(model){
                this.filterableFields = this._getFilterableFields(model);
                this._initializeFilters(this.filters);
            }
        });
    },
    _getFilterableFields: function(model){
        var fields = model.getFields(),
            whitelistFields = this.whitelistFields,
            filterableFields = [],
            dropdownListFields = this.includeDropdownFields;

        _.each(fields, function(f){
            if (f.hidden === false && f.attributeDefinition){
                var attr_def = f.attributeDefinition;

                if (Ext.Array.contains(whitelistFields, attr_def.ElementName)){
                    filterableFields.push(f);
                } else {
                    console.log('aatr',attr_def);
                    if (dropdownListFields && attr_def.Constrained &&
                        attr_def.AttributeType == 'STRING'){
                        filterableFields.push(f);
                    }
                }
            }
        },this);
        this.logger.log('filterableFields',filterableFields);
        this.filterFields = _.uniq(filterableFields);
    },
    _initializeFilters: function(filters){
        this.logger.log('_initializeFilters', filters);

        if (filters && filters.length > 0){
            Ext.each(filters, function(filter){
                this._addNewRow(filter.property, filter.operator, filter.value);
            },this);
        } else {
            this._addNewRow();
        }
    },
    _getFieldStore: function(){
        var fields = [];
        Ext.each(this.filterFields, function(field){
            fields.push({
                name: field.name,
                displayName: field.displayName,
                attributeType: field.attributeDefinition.AttributeType,
                schemaType: field.attributeDefinition.SchemaType,
                modelType: field.modelType,
                isConstrained: field.attributeDefinition.Constrained
            });
        },this);

        return Ext.create('Rally.data.custom.Store',{
            data: fields
        });
    },
    _addNewRow: function(property, operator, value) {
        this.logger.log('_addNewRow', property, operator, value);

        var field_store = this._getFieldStore(this.filterableFields);
        var items = [];
        items.push({
            xtype: "rallybutton",
            itemId: 'btn-remove',
            text: '-',
            scope: this,
            margin: 5,
            handler: function(btn){
                btn.bubble(this._removeRow, this);
            }
        });

        items.push({
            xtype: "rallycombobox",
            itemId: 'cb-filter-field',
            store: field_store,
            displayField: 'displayName',
            valueField: 'name',
            listeners: {
                scope: this,
                select: function(cb){
                    this._updateFilterCombos(cb, operator, value);
                },
                ready: function(cb){
                    if (property) {
                        cb.setValue(property);
                        this._updateFilterCombos(cb,operator,value);
                    }
                }
            },
            allowNoEntry: true,
            noEntryText: 'Choose Field...',
            noEntryValue: null,
            margin: 5,
            value: null
        });

        var row = Ext.create('Ext.Container',{
            layout: {type: 'hbox'},
            items: items

        });
        this.down('#ct-rows').add(row);
        this._validateFilters();
    },
    _updateFilterCombos: function(cb, operator, value){
        var parent_ct = cb.up(null,1);
        var rec = cb.getRecord();

        this.logger.log('_updateFilterCombos', cb.itemId, rec, operator, value);

        if (parent_ct){
            if (parent_ct.down('#cb-filter-operator')) {
                parent_ct.down('#cb-filter-operator').destroy();
                parent_ct.down('#cb-filter-value').destroy();
            }

            var op_val = operator || '=';
            var operator_ctl = this._getOperatorControl(rec, op_val, 'cb-filter-operator');
            parent_ct.add(operator_ctl);

            var value_val = value || null;
            var value_ctl = this._getValueControl(rec, value_val, 'cb-filter-value');
            parent_ct.add(value_ctl);

        }
    },

    _removeRow: function(btn){
        var ct = btn.up(null,1);
        if (ct){
            ct.destroy();
        }
        this._validateFilters();
    },
    _getButtonConfig: function() {
        return [{
            xtype: "rallybutton",
            itemId: "cancelButton",
            cls: "secondary rly-small",
            text: "Cancel",
            width: 90,
            handler: this._onCancelClick,
            scope: this
        }, {
            xtype: "rallybutton",
            itemId: "applyButton",
            cls: "primary rly-small",
            text: "Apply",
            width: 90,
            handler: this._onApplyClick,
            scope: this,
            disabled: true
        }]
    },
    _onClearAll: function(){
        this.down('#ct-rows').removeAll();
        this._addNewRow();
    },
    _onCancelClick: function() {
        this.destroy()
    },
    _validateFilters: function(ct){
        var disabled = false;
        var add_disabled = false;

        var rows = this.down('#ct-rows').items.items;
        if (rows.length == 0){
            disabled = true;
        }

        Ext.each(this.down('#ct-rows').items.items, function(item){
            item.down('#btn-remove').setDisabled(rows.length == 1);

            var property = null;
            if (item.down('#cb-filter-field')){
                property = item.down('#cb-filter-field').getValue();
            }
            var operator = null;
            if (item.down('#cb-filter-operator')){
                operator = item.down('#cb-filter-operator').getValue();
            }

            if (property == null || operator == null || property.length == 0 || operator.length == 0){
                disabled = true, add_disabled = true;
            }

            var val = null;
            if (item.down('#cb-filter-value')){
                val = item.down('#cb-filter-value').getValue()
                if (item.down('#cb-filter-value').xtype == 'rallynumberfield'){
                    if (val == null || val.toString.length == 0){
                        disabled = true, add_disabled = true;
                    }
                }
            };
            if (rows.length == 1 && property == null && operator == null && val == null){
                disabled = false;   //clear filters
            }
        }, this);
        this.logger.log('_validateFilters',disabled);
        this.down('#applyButton').setDisabled(disabled);
        this.down('#btn-add').setDisabled(add_disabled);
    },
    /*
     * In some cases, we want to strip the value returned or make it look
     * different somehow.  (E.g., we want the preliminary estimate to just show the ID
     */
    _cleanValue: function(val) {
        if ( /\/preliminaryestimate\//.test(val)) {
            val = val.replace(/\/preliminaryestimate\//,"");
            val = parseInt(val,10);
        }
        if (/\/state\//.test(val)) {
            val = val.replace(/\/state\//,"")
            val = parseInt(val,10);
        }


        return val;
    },
    _onApplyClick: function() {
        var filters = [];
        Ext.each(this.down('#ct-rows').items.items, function(item){
            if (this.down('#cb-filter-operator')){
                var property = item.down('#cb-filter-field').getValue();
                var operator = item.down('#cb-filter-operator').getValue();
                var val = this._cleanValue( item.down('#cb-filter-value').getValue() );
                var display_property = item.down('#cb-filter-field').getRecord().get('displayName');
                var display_value = item.down('#cb-filter-value').displayValue || val;

                if (property && operator) {
                    filters.push({
                        property: property,
                        operator: operator,
                        value: val,
                        displayProperty: display_property,
                        displayValue: display_value
                    });
                }
            }
        }, this);

        this.fireEvent("customfilter", filters);
        this.destroy()
    },
    _getItems: function() {
        return [{
            xtype: "container",
            cls: "custom-filter-header",
            layout: {type: 'hbox'},
            defaults: {
                xtype: "component",
                cls: "filter-panel-label"
            },
            items: [{
                height: 1,
                width: 30
            }, {
                html: "Field",
                width: 155
            }, {
                html: "Operator",
                width:  80
            }, {
                html: "Value",
                width:  155
            }]
        }, {
            xtype: "container",
            itemId: "ct-rows",
            layout: {type: 'vbox'}
        },{
            xtype: "container",
            itemId: 'ct-footer',
            items: [{
                xtype:'rallybutton',
                itemId: 'clearButton',
                cls: "secondary rly-small",
                text: 'Clear All',
                width: 90,
                align: 'right',
                margin: '5 5 5 220',
                scope: this,
                handler: this._onClearAll
            },{
                xtype:'rallybutton',
                itemId: 'btn-add',
                text: 'Add New',
                width: 90,
                cls: "primary rly-small",
                align: 'right',

                margin: 5,
                scope: this,
                handler: this._addNewRow
            }]
        }]
    },
    _getOperatorControl: function(field, operatorValue, itemId){
        this.logger.log('_getOperatorControl',field, operatorValue);
        var operators = ['='];
        var operator_value = operatorValue || '=';
        //We should be able to get these back from the field, but its not consistent
        //so we are going to cheat and hardcode them
        if (!field.get('isConstrained')){
            switch(field.get('attributeType')){
                case 'STRING':
                case 'TEXT':
                    operators = ['=','contains'];
                    break;
                case 'DECIMAL':
                case 'INTEGER':
                case 'QUANTITY':
                    operators = ['=','<=','>=','<','>'];
                    break;
                case 'DATE':
                    operators = ['on','before', 'after'];
            }
        }

        var op_ctl = {
            xtype: "rallycombobox",
            itemId: itemId,
            store: operators,
            margin: 5,
            width: 80,
            allowNoEntry: false,
            noEntryText: '',
            listeners: {
                scope: this,
                change: this._validateFilters,
                ready: function(cb){
                    cb.setValue(operator_value);
                }
            }
        };
        return op_ctl;
    },
    _getValueControl: function(field, value, item_id){
        this.logger.log('_getValueControl',field)

        var ctl = {xtype: 'rallytextfield'};
        var type = field.get('attributeType');
        var hasAllowedValues = ((type == 'STATE') || (type=='RATING') || field.get('isConstrained'));
        var schema = field.get('schemaType');
        var field_name = field.get('name');
        var model_type = field.get('modelType');

        var app = this.app;

        switch(type){
            case 'BOOLEAN':
                ctl = {
                    xtype: 'rallycombobox',
                    allowNoEntry: false,
                    store: ['true','false']
                };
                break;
            case 'DATE':
                ctl = {
                    xtype: 'rallydatefield',
                    allowNoEntry: false
                };
                break;
            case 'TEXT':
            case 'STRING':
            case 'STATE':
            case 'RATING':
                if (hasAllowedValues){
                    ctl = {
                        xtype: 'rallyfieldvaluecombobox',
                        model: model_type,
                        field: field_name,
                        allowNoEntry: false
                    };
                }
                break;
            case 'OBJECT':
                //Release, Iteration, User, Project, artifact links
                if (schema == 'Iteration') {
                    ctl = {
                        xtype: 'rallyiterationcombobox',
                        allowNoEntry: false
                    };
                } else if (schema == 'Release') {
                    ctl = {
                        xtype: 'rallyreleasecombobox',
                        allowNoEntry: false
                    };
                } else if (schema == 'User') {
                    ctl = {
                        xtype: 'rallyusersearchcombobox',
                        project: app.getContext().getProject(),
                        allowNoEntry: false,
                        valueField: 'ObjectID'
                    };
                } else if (schema == 'Project') {
                    ctl = {
                        xtype: 'rallyprojectpicker',
                        allowNoEntry: false
                    };

                } else if ( (schema == 'State') || ( schema == 'PreliminaryEstimate' ) ) {
                    ctl = {
                        xtype: 'rallyfieldvaluecombobox',
                        prefix: Ext.util.Format.lowercase(schema),
                        model: model_type,
                        field: field_name,
                        allowNoEntry: false
                    };
                }
                break;
            case 'DECIMAL':
            case 'INTEGER':
            case 'QUANTITY':
                ctl = {
                    xtype: 'rallynumberfield',
                    allowBlank: false
                }
        }
        _.extend(ctl, {
            itemId: item_id,
            margin: 5,
            listeners: {
                scope: this,
                change: function(cb) {
                    if ( cb.xtype == "rallyfieldvaluecombobox" ) {
                        cb.displayValue = cb.getRecord().get("name");
                    }

                    if ( cb.xtype == "rallyusersearchcombobox" ) {
                        cb.displayValue = cb.getRecord().get("_refObjectName");
                    }
                    this._validateFilters();
                },
                ready: function(cb){
                    if (value){
                        cb.setValue(value);
                    }
                },
                render: function(cb){
                    if (value){
                        if (cb.xtype == "rallyusersearchcombobox") {
                            value = "/user/" + value;
                        }
                        if ( cb.prefix && value > 0 ) {
                            value = "/" + cb.prefix + "/" + value;
                        }

                        cb.setValue(value);
                    }
                }
            }
        });
        return ctl;
    }
});

Ext.define('Rally.technicalservices.Toolbox',{
    singleton: true,
    /**
     * Returns beginnig of month as date for the current time zone
     *
     */
    getBeginningOfMonthAsDate: function(dateInMonth){
        var year = dateInMonth.getFullYear();
        var month = dateInMonth.getMonth();
        return new Date(year,month,1,0,0,0,0);
    },
    getEndOfMonthAsDate: function(dateInMonth){
        var year = dateInMonth.getFullYear();
        var month = dateInMonth.getMonth();
        var day = new Date(year, month+1,0).getDate();
        return new Date(year,month,day,0,0,0,0);
    },
    aggregateSnapsByOid: function(snaps){
        //Return a hash of objects (key=ObjectID) with all snapshots for the object
        var snaps_by_oid = {};
        Ext.each(snaps, function(snap){
            var oid = snap.ObjectID || snap.get('ObjectID');
            if (snaps_by_oid[oid] == undefined){
                snaps_by_oid[oid] = [];
            }
            snaps_by_oid[oid].push(snap);

        });
        return snaps_by_oid;
    },
    getCaseInsensitiveKey: function(obj, inputStr){
        var new_key = inputStr;
        Ext.Object.each(obj, function(key, val){
            if (new_key.toLowerCase() == key.toLowerCase()){
                new_key = key;
            }
        });
        return new_key;

    },
    aggregateSnapsByOidForModel: function(snaps){
        //Return a hash of objects (key=ObjectID) with all snapshots for the object
        var snaps_by_oid = {};
        Ext.each(snaps, function(snap){
            var oid = snap.ObjectID || snap.get('ObjectID');
            if (snaps_by_oid[oid] == undefined){
                snaps_by_oid[oid] = [];
            }
            snaps_by_oid[oid].push(snap.getData());

        });
        return snaps_by_oid;
    },
    getDateBuckets: function(startDate, endDate, granularity){

        var bucketStartDate = Rally.technicalservices.Toolbox.getBeginningOfMonthAsDate(startDate);
        var bucketEndDate = Rally.technicalservices.Toolbox.getEndOfMonthAsDate(endDate);

        var date = bucketStartDate;

        var buckets = [];
        while (date<bucketEndDate && bucketStartDate < bucketEndDate){
            buckets.push(date);
            date = Rally.util.DateTime.add(date,granularity,1);
        }
        return buckets;
    },
    formatDateBuckets: function(buckets, dateFormat){
        var categories = [];
        Ext.each(buckets, function(bucket){
            categories.push(Rally.util.DateTime.format(bucket,dateFormat));
        });
        categories[categories.length-1] += "*";
        return categories;
    }
});

Ext.define("ts-feature-schedule-report", {
    extend: 'Rally.app.App',
    componentCls: 'app',
    logger: new Rally.technicalservices.Logger(),
    defaults: { margin: 10 },

    portfolioItemFeature: 'PortfolioItem/Feature',
    featureFetchList: ['ObjectID','FormattedID','Name','c_FeatureTargetSprint','Project','State','c_CodeDeploymentSchedule','DisplayColor'],
    featureFetchHydrateList: ['Project'],
    pivotFieldName: 'c_FeatureTargetSprint',
    otherText: 'Fix Target Sprint',
    warningIcon: '<img src="/slm/images/icon_alert_sm.gif">',
    allReleasesText: 'All Releases',
    historicalDateRangeInDays: -14,
    
    timeboxType: 'targetSprint',
    timeboxNames: [],
    
    onNoAvailableTimeboxes: function(){
        this.logger.log('No available releases');
    },
    onScopeChange: function(cb){
        this.logger.log('onScopeChange', cb,cb.getValue());
        this._updateApp(cb.getRecord());
    },
    launch: function(){
        this._initLayoutComponents();
    },
    _updateApp: function(){
        this.logger.log('_updateApp');
        this.down('#ct-body').removeAll();
        this.setLoading({msg: 'Loading data...', fixed: true});

        var promises = [this._fetchFeatureData(), this._fetchHistoricalFeatureData()];
        Deft.Promise.all(promises).then({
            scope: this,
            success: function(recordsArray){
                this.logger.log('Promises success',recordsArray);
                var recordsObject = {currentRecords: recordsArray[0], historicalRecords: recordsArray[1]};
                this.setLoading(false);
                this._createDataStore(recordsObject);
            },
            failure: function(operation){
                this.logger.log('Promise failure', operation);
                this.setLoading(false);
                var msg =  'Error retrieving Portfolio Item data:  ';
                if (typeof operation === 'object'){
                   msg +=  operation.error.errors[0]
                } else {
                    msg += operation;
                }
                Rally.ui.notify.Notifier.showError({message: msg});
            }
        });
    },
    _getPreviousValuesPivotField: function(){
        return "_PreviousValues." + this.pivotFieldName;
    },
    _fetchHistoricalFeatureData: function(){
        var deferred = Ext.create('Deft.Deferred'),
            historicalDateRange = Rally.util.DateTime.toIsoString(Rally.util.DateTime.add(new Date(),"day",this.historicalDateRangeInDays)),
        fetchList = Ext.clone(this.featureFetchList);
        fetchList.push(this._getPreviousValuesPivotField());
        var find = {
                "_TypeHierarchy": this.PortfolioItemFeature,
                "_ValidTo": {$gte: historicalDateRange},
                "_ProjectHierarchy": this.getContext().getProject().ObjectID
            };
        find[this._getPreviousValuesPivotField()] = {$exists: true};

        var store = Ext.create('Rally.data.lookback.SnapshotStore',{
            limit: 'Infinity',
            findConfig:find,
            removeUnauthorizedSnapshots: true,
            fetch: fetchList,
            hydrate: this.featureFetchHydrateList
        });
        store.load({
            scope: this,
            callback: function(records, operation, success){
                this.logger.log('_fetchHistoricalFeatureData callback',success);
                if (success) {
                    deferred.resolve(records);
                } else {
                    deferred.reject(operation);
                }
            }
        });
        return deferred;
    },
    
    _fetchPivotFields: function() {
        var deferred = Ext.create('Deft.Deferred');
        
        var me = this;
        var pivotFieldName = this.pivotFieldName;

        Rally.data.wsapi.ModelFactory.getModel({
            type: this.portfolioItemFeature,
            success: function(model) {
                var field = model.getField(pivotFieldName);
                return field.getAllowedValueStore().load({
                    scope: this,
                    callback: function(records, operation, success){
                        if (success){
                            var pivotFields = [];
                            _.each(records, function(r){
                                if (r && r.get('StringValue') && r.get('StringValue').length > 0){
                                    pivotFields.push(r.get('StringValue'));
                                }
                            });
                            
                            if ( me.timeboxType != "Release" && me.timeboxNames.length > 0) {
                                pivotFields = Ext.Array.filter(pivotFields,function(field){
                                    return ( Ext.Array.contains(me.timeboxNames, field) ) ;
                                });
                            }
                            deferred.resolve(pivotFields);
                        } else {
                            deferred.reject(operation);
                        }
                    }
                });
            }
        });
        return deferred;
    },
    
    _getFilters: function(){
        var me = this;
        
        if ( this.timeboxType == "release" ) {

            var releaseValue = this.down('#cb-release').getValue();
            var release = this.down('#cb-release').getRecord(),
                filters = [];
            this.logger.log('_getFilters',releaseValue);
    
            if (release){
                if (releaseValue.length > 0){  //releaseValue == '' for All releases
                    filters = [{
                        property: 'Release.Name',
                        value: release.get('Name')
                    }];
                }
            } else {  //Release record == null, which is unscheduled
                filters = [{
                    property: 'Release',
                    value: ''
                }];
            }
        } else {
            if ( !Ext.isEmpty(this.timeboxNames) ) {
                filters = Ext.Array.map(this.timeboxNames, function(name){
                    return {property:me.pivotFieldName,value:name};
                });
            } else {
                filters = [{property:'ObjectID',operator: '>',value:0}];
            }
        }
        
        filters = Rally.data.wsapi.Filter.or(filters);
        
        var currentFilters = this.currentFilters || [];
        _.each(currentFilters, function(f){
            filters = filters.and(
                Ext.create('Rally.data.wsapi.Filter', {
                    property: f.property,
                    operator: f.operator,
                    value: f.value
                })
            );
        })
        
        

        this.logger.log('Filters', filters);
        return filters;

    },
    _fetchFeatureData: function(){
        var deferred = Ext.create('Deft.Deferred');

        var store = Ext.create('Rally.data.wsapi.Store',{
            model: this.portfolioItemFeature,
            fetch: this.featureFetchList,
            filters: this._getFilters(),
            context: {projectScopeDown: true},
            limit: 'Infinity'
        });

        return store.load({
            callback: function(records, operation, success){
                this.logger.log('_fetchFeatureData callback',success, operation);
                if (success){
                    deferred.resolve(records);
                } else {
                    deferred.reject(operation);
                }
            },
            scope: this
        });
        return deferred;
    },
    _buildDataStore: function(records, historicalRecords, pivotFieldValues){
        var projects = {},
            pivotFieldName = this.pivotFieldName;

        this.logger.log('_buildDataStore',records, historicalRecords,pivotFieldValues);

        _.each(records, function(r){
            var project_oid = r.get('Project')._ref;
            if (projects[project_oid] == undefined){
                projects[project_oid] = [];
            }
            projects[project_oid].push(r);
        });

        var snaps_by_oid = Rally.technicalservices.Toolbox.aggregateSnapsByOidForModel(historicalRecords);

        var otherText = this.otherText;

        var data = [];

        _.each(projects, function(objs, project_oid){
            var rec = {Project: objs[0].get('Project').Name};
            rec[otherText] = [];
            _.each(pivotFieldValues, function(pf){
                rec[pf] = [];
            });

            _.each(objs, function(obj){
                var newObj = obj.getData();
                if (snaps_by_oid[obj.get('ObjectID')]){
                    newObj.Flagged = true;
                }
                var pivotValue = obj.get(pivotFieldName) || otherText;
                if (_.indexOf(pivotFieldValues,pivotValue) >= 0){
                    rec[pivotValue].push(newObj);
                } else {
                    rec[otherText].push(newObj);
                }
            });

            data.push(rec);
        });

        this.logger.log('data for store', data);
        var otherStoriesExist = false;
        _.each(data, function(rec){
            if (rec[otherText] && rec[otherText].length > 0){
                otherStoriesExist = true;
            }
        });
        this.otherStoriesExist = otherStoriesExist;

        var store= Ext.create('Rally.data.custom.Store',{
            data: data,
            pageSize: data.length
        });
        return store;

    },
    _createDataStore: function(recordsObject) {
        var pivotFieldName = this.pivotFieldName,
            records = recordsObject.currentRecords,
            historicalRecords = recordsObject.historicalRecords;
        this.logger.log('_createDataStore');
        this._fetchPivotFields().then({
            scope: this,
            success: function(pivotFieldValues){
                var store = this._buildDataStore(records, historicalRecords, pivotFieldValues);
                this._createGrid(store, pivotFieldValues, this.otherStoriesExist);
            }
        });
    },

    _createGrid: function(store, pivotFields, otherStoriesExist) {
        this.logger.log('_createGrid',store);

        this.down('#ct-body').removeAll();

        this.down('#ct-body').add({
            xtype: 'rallygrid',
            columnCfgs: [
                {dataIndex: 'Project', text: 'Project', width: 200, tdCls: 'project'}/*,
                {
                    dataIndex: this.otherText,
                    text: this.otherText + this.warningIcon,
                    hidden: !otherStoriesExist,
                    renderer: this._featureRenderer
                }*/
            ].concat(_.map(pivotFields, function(pivotField) {
                    return {
                        dataIndex: pivotField,
                        flex: 1,
                        text: pivotField,
                        renderer: this._featureRenderer
                    };
                },this)),
            store: store,
            showPagingToolbar: false
        });
    },
    _featureRenderer: function(value, metadata, record){
        metadata.tdCls = 'ts-column-style';

        if (value && value.length > 0){
            var msg = '';
            _.each(value, function(v){
                var state = v.State ? v.State.Name : '',
                    cds = v.c_CodeDeploymentSchedule ? v.c_CodeDeploymentSchedule : 'Missing',
                    warning = '';
                if (v.c_CodeDeploymentSchedule){
                    cds = v.c_CodeDeploymentSchedule;
                } else {
                    cds = '<img src="/slm/images/icon_alert_sm.gif" alt="CDS Missing" title="Warning: Code Deployment Schedule is missing!"><span class="ts-warning">Missing Code Deployment Schedule</span>';
                }
                var link =  Rally.nav.DetailLink.getLink({record: v._ref, text: v.FormattedID});
                var featureClass = v.Flagged ? 'tsflagged' : 'tscurrent';
                msg += Ext.String.format('<div class="tscolor" style="background-color:{0};width:10px;height:10px;"></div><span class="{1}">{2}[{3}]&nbsp;{4}: {5}<br/><b><i>{6}</i></b></span><hr class="ts-separator"/>',
                    v.DisplayColor,
                    featureClass,
                    warning,
                    state,
                    link,
                    v.Name,
                    cds);

            });
            return msg.replace(/<hr class="ts-separator"\/>$/,'');
        }
        return '';

    },
    _initLayoutComponents: function(){
        //Add the high level body components if they haven't already been added.
        if (!this.down('tsinfolink')){
            this.add({xtype:'container',itemId:'ct-header', cls: 'header', layout: {type: 'hbox'}});
            this.add({xtype:'container',itemId:'ct-body'});
            this.add({xtype:'tsinfolink'});

            if ( this.timeboxType == "release" ) {
                this.down('#ct-header').add({
                    xtype: 'rallyreleasecombobox',
                    fieldLabel: 'Release',
                    itemId: 'cb-release',
                    labelAlign: 'right',
                    width: 300,
                    allowNoEntry: true,
                    storeConfig: {
                        listeners: {
                            scope: this,
                            load: this._addAllOption
                        }
                    },
                    listeners: {
                        scope: this,
                        change: this.onScopeChange
                    }
                });
            } else {
                this.down('#ct-header').add({
                    xtype:'rallybutton',
                    itemId: 'btn-target-sprints',
                    text: 'Choose TargetSprint(s)',
                    cls: 'small-icon secondary rly-small',
                    listeners: {
                        scope: this,
                        click: this._launchTargetSprintPicker
                    }
                });
            }

            this.down('#ct-header').add({
                xtype: 'rallybutton',
                itemId: 'btn-filter',
                scope: this,
                cls: 'small-icon secondary rly-small',
                iconCls: 'icon-filter',
                margin: '0 10 10 10',
                handler: this._filter
            });
            this.down('#ct-header').add({xtype:'container',
                itemId:'filter_box',
                margin: '0 10 10 10',
                tpl:'<div class="ts-filter"><i>Filters:&nbsp;<tpl for=".">{displayProperty} {operator} {displayValue}&nbsp;&nbsp;&nbsp;&nbsp;</tpl></i></div>'});

            this.down('#ct-header').add({
                xtype:'container',
                flex: 1,
                itemId:'spacer'
            });
            
            this.down('#ct-header').add({
                xtype:'container',
                width: 200,
                margin: '0 10 10 10',
                html: '<div class="legend">Text Color: <li><div class="tsflagged">Items have been pushed</div><li><div class="tscurrent">Current</div></div>'

            });
        }
    },
    _addAllOption: function(store){
        store.add({Name: this.allReleasesText, formattedName: this.allReleasesText});
    },
    
    _launchTargetSprintPicker: function(btn) {
        Ext.create('Rally.technicalservices.FieldValueDialog',{
            artifactType: 'PortfolioItem',
            artifactField: this.pivotFieldName,
            allowEmptyResponse: true,
            listeners: {
                scope: this,
                valuechosen: function(dialog,values) {
                    this.logger.log("Selected Values: ", values);
                    var string_values = Ext.Array.map(values, function(value) {
                        return value.get('StringValue');
                    })
                    this.timeboxNames = string_values;
                    if (Ext.isEmpty(this.timeboxNames)){
                        btn.removeCls('primary');
                        btn.addCls('secondary');
                    } else {
                        btn.removeCls('secondary');
                        btn.addCls('primary');
                    }
                    this._updateApp();
                }
            }
        }).show();
    },
    
    _filter: function(btn){
        this.logger.log('_filter', this.filterFields);
        Ext.create('Rally.technicalservices.dialog.Filter',{
            filters: this.currentFilters,
            title: 'Filter Features By',
            app: this,
            listeners: {
                scope: this,
                customFilter: function(filters){
                    this.logger.log('_filter event fired',filters);
                    this.currentFilters = filters;
                    if (filters.length == 0){
                        btn.removeCls('primary');
                        btn.addCls('secondary');
                        this.down('#filter_box').update('');
                    } else {
                        btn.removeCls('secondary');
                        btn.addCls('primary');
                        this.down('#filter_box').update(this.currentFilters);
                    }

                    this._updateApp();
                }
            }
        });
    }
});

            
               Rally.launchApp('ts-feature-schedule-report', {
                   name: 'Feature Schedule Report'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}

.tscolor {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    text-align: center;
    color: white;
    border-style: solid;
    border-width: 1px;
    display: inline-block;
}

.tscolor-flagged {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    text-align: center;
    color: #0000ff;
    border-style: solid;
    border-width: 2px;
    display: inline-block;
}

.ts-column-style {
    border-style: solid;
    border-left-width: 1px;
    border-left-color: #e0e0e0;
}
.ts-separator {
    height: 1px;
    background-color: #e0e0e0;
    border: 0;
}
.ts-warning {
    color: #FF0000;
}
.tscurrent {
  color: #000000;
}

.tsflagged {
    color: #AA22FF;
}
.project {
    font-weight: 900;
}

.legend {
}

.legend .tscurrent, .legend .tsflagged {
    margin-left: 25px;
}
    </style>

</head>
<body></body>
</html>